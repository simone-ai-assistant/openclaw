name: Sync Upstream

on:
  schedule:
    # Run every hour
    - cron: '0 * * * *'
  workflow_dispatch: # Allow manual trigger

# Permissions needed for pushing changes
permissions:
  contents: write

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.PAT_TOKEN || secrets.GITHUB_TOKEN }}

    - name: Configure Git
      run: |
        git config user.name "Simone Bot"
        git config user.email "sim0ne.idle@gmail.com"

    - name: Add Upstream Remote
      run: |
        git remote add upstream https://github.com/openclaw/openclaw.git
        git fetch upstream

    - name: Sync Main Branch
      run: |
        git checkout main
        git merge upstream/main --no-edit || true

    - name: Push Changes
      run: |
        git push origin main

    - name: Sync Other Branches
      run: |
        # Get all upstream branches (limit to first 10 to avoid timeout)
        branches=$(git branch -r | grep upstream/ | grep -v HEAD | sed 's/upstream\///' | head -10)
        failed_branches=""

        for branch in $branches; do
          echo ""
          echo "=== Processing branch: $branch ==="

          # Always return to main before processing next branch
          git checkout main || true

          if git show-ref --verify --quiet refs/heads/$branch; then
            echo "Branch exists locally, syncing..."
            if git checkout $branch; then
              if git merge upstream/$branch --no-edit; then
                if git push origin $branch; then
                  echo "✓ Successfully synced: $branch"
                else
                  echo "✗ Push failed for: $branch"
                  failed_branches="$failed_branches $branch(push)"
                fi
              else
                echo "✗ Merge failed for: $branch"
                failed_branches="$failed_branches $branch(merge)"
              fi
            else
              echo "✗ Checkout failed for: $branch"
              failed_branches="$failed_branches $branch(checkout)"
            fi
          else
            echo "Creating new branch: $branch"
            if git checkout -b $branch upstream/$branch; then
              if git push origin $branch; then
                echo "✓ Successfully created: $branch"
              else
                echo "✗ Push failed for new branch: $branch"
                failed_branches="$failed_branches $branch(push-new)"
              fi
            else
              echo "✗ Checkout failed for new branch: $branch"
              failed_branches="$failed_branches $branch(checkout-new)"
            fi
          fi
        done

        # Return to main
        git checkout main || true

        # Report results
        echo ""
        echo "=== Sync Summary ==="
        if [ -z "$failed_branches" ]; then
          echo "✓ All branches synced successfully!"
        else
          echo "⚠ Some branches failed:$failed_branches"
          echo "Main branch was synced successfully."
        fi
      continue-on-error: true
